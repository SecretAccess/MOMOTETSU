<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Momotetsu Point Manager</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* --- カラーパレット --- */
    :root {
      --primary: #2196F3;
      --primary-dark: #1976D2;
      --primary-light: #BBDEFB;
      --secondary: #FF4081;
      --secondary-dark: #C2185B;
      --accent: #FFC107;
      --bg: #F5F5F5;
      --card-bg: #FFFFFF;
      --text: #212121;
      --text-secondary: #757575;
      --divider: #BDBDBD;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 10px rgba(0,0,0,0.15);
      --border-radius: 8px;
      --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* --- ダークモード --- */
    .dark-mode {
      --primary: #42A5F5;
      --primary-dark: #1976D2;
      --primary-light: #64B5F6;
      --secondary: #FF80AB;
      --secondary-dark: #C2185B;
      --accent: #FFD54F;
      --bg: #121212;
      --card-bg: #1E1E1E;
      --text: #FFFFFF;
      --text-secondary: #B0B0B0;
      --divider: #424242;
    }

    /* --- リセット & ベース --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }
    
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 0 1rem; 
      padding-bottom: 2rem;
    }

    h1, h2, h3, h4, h5, h6 {
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    button {
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      border: none;
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      transition: var(--transition);
      background: var(--primary);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    button:active {
      transform: translateY(0);
      box-shadow: var(--shadow);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button i {
      font-size: 0.9em;
    }

    input, select {
      padding: 0.5rem;
      border: 1px solid var(--divider);
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--text);
      background: var(--card-bg);
      transition: var(--transition);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    /* --- トグルスイッチ --- */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--divider);
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .switch input:checked + .slider {
      background-color: var(--primary);
    }

    .switch input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* --- ヘッダー --- */
    header {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .header-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
    }

    #doubleToggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #yearTimerContainer {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .year-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .timer-display {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #menu {
      display: flex;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-accent {
      background: var(--accent);
      color: var(--text);
    }

    .btn-danger {
      background: #F44336;
    }

    .btn-success {
      background: #4CAF50;
    }

    .btn-warning {
      background: #FF9800;
    }

    .btn-info {
      background: #00BCD4;
    }

    .btn-dark {
      background: #424242;
    }

    .btn-icon {
      width: 36px;
      padding: 0.5rem;
    }

    /* --- メインコンテンツ --- */
    .panel {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }

    .panel:hover {
      box-shadow: var(--shadow-hover);
    }

    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--divider);
      font-size: 1.2rem;
      font-weight: 500;
    }

    .panel-title i {
      margin-right: 0.5rem;
      color: var(--primary);
    }

    /* --- プレイヤーカード --- */
    #board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .player-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      transform-origin: center;
    }

    .player-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .player-header {
      padding: 0.75rem;
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
      position: relative;
      overflow: hidden;
    }

    .player-header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }

    .player-card:hover .player-header::after {
      transform: translateX(100%);
    }

    .player-body {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .player-points {
      font-size: 1.5rem;
      text-align: center;
      font-weight: 500;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: var(--border-radius);
      background: var(--bg);
      color: var(--text);
    }

    .player-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .player-buttons button {
      padding: 0.5rem;
      font-size: 0.85rem;
    }

    /* プレイヤーカードの色のパターン化と改善 */
    .player-color-1 .player-header { background: linear-gradient(135deg, #2196F3, #0D47A1); }
    .player-color-2 .player-header { background: linear-gradient(135deg, #E91E63, #880E4F); }
    .player-color-3 .player-header { background: linear-gradient(135deg, #FFC107, #FF6F00); }
    .player-color-4 .player-header { background: linear-gradient(135deg, #4CAF50, #1B5E20); }
    .player-color-5 .player-header { background: linear-gradient(135deg, #9C27B0, #4A148C); }
    .player-color-6 .player-header { background: linear-gradient(135deg, #FF5722, #BF360C); }

    /* --- ルールパネル --- */
    #rulesList {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .rule-entry {
      padding: 0.75rem;
      border-radius: var(--border-radius);
      background: var(--bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .rule-entry:hover {
      box-shadow: var(--shadow);
    }

    .rule-content {
      flex: 1;
    }

    .rule-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .rule-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .rule-by {
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 500;
    }

    .rule-entry.deleted {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .rule-action {
      margin-left: 1rem;
    }

    /* --- ログパネル --- */
    #logs {
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0.5rem;
      margin-top: 0.5rem;
    }

    .log-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      background: var(--bg);
      transition: var(--transition);
    }

    .log-entry:hover {
      box-shadow: var(--shadow);
    }

    .log-entry:last-child {
      margin-bottom: 0;
    }

    .log-entry.latest {
      background: var(--primary-light);
      font-weight: 500;
    }

    .log-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-right: 0.5rem;
    }

    .log-message {
      flex: 1;
    }

    .log-action button {
      background: transparent;
      color: #F44336;
      padding: 0.25rem;
      box-shadow: none;
    }

    .log-action button:hover {
      background: rgba(244, 67, 54, 0.1);
      transform: none;
      box-shadow: none;
    }

    /* --- モーダル --- */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .modal-backdrop.active .modal {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--divider);
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 500;
    }

    .modal-close {
      background: transparent;
      color: var(--text-secondary);
      padding: 0.25rem;
      box-shadow: none;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text);
      transform: none;
      box-shadow: none;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin: 1rem 0;
    }

    .stepper-value {
      font-size: 1.5rem;
      font-weight: 500;
      width: 100px;
      text-align: center;
    }

    .stepper button {
      width: 40px;
      height: 40px;
      padding: 0;
      font-size: 1.2rem;
      border-radius: 50%;
    }

    .player-select {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }

    /* --- ランキングテーブル --- */
    .rank-table {
      width: 100%;
      margin-bottom: 1rem;
      border-collapse: collapse;
    }

    .rank-table th,
    .rank-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--divider);
    }

    .rank-table th {
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg);
    }

    .rank-table tr:last-child td {
      border-bottom: none;
    }

    .rank-table tr:hover td {
      background: var(--bg);
    }

    /* --- カード設定 --- */
    .card-form {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .card-form:hover {
      box-shadow: var(--shadow);
    }

    .card-form-fields {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* --- アニメーション --- */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    /* --- レスポンシブ --- */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .controls-container {
        flex-direction: column;
        align-items: stretch;
      }

      #menu {
        justify-content: space-between;
      }

      .player-buttons {
        grid-template-columns: 1fr;
      }

      .player-select {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .panel {
        padding: 0.75rem;
      }

      .modal {
        padding: 1rem;
      }

      .stepper {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* --- スクロールバーのカスタマイズ --- */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--divider);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* --- ツールチップ --- */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="app-title">
          <i class="fas fa-train"></i> Momotetsu Point Manager
        </div>
        <div class="controls-container">
          <!-- 倍モードトグル -->
          <div id="doubleToggle">
            <label class="switch">
              <input type="checkbox" id="doubleMode">
              <span class="slider"></span>
            </label>
            <label for="doubleMode">倍モード</label>
          </div>

          <!-- 年数＆タイマー -->
          <div id="yearTimerContainer">
            <div class="year-controls">
              <span id="currentYearDisplay">1年目</span>
              <button id="nextYearBtn" class="btn-primary">
                <i class="fas fa-forward"></i> 次の年へ
              </button>
            </div>
            <div class="timer-display">
              <div id="totalTimerDisplay">通算: 00:00:00</div>
              <div id="yearTimerSingleDisplay">本年: 00:00:00</div>
            </div>
          </div>

          <!-- メニュー -->
          <div id="menu">
            <button id="rankBtn" class="btn-accent">
              <i class="fas fa-trophy"></i> ランキング
            </button>
            <button id="settingsBtn" class="btn-secondary">
              <i class="fas fa-cog"></i> 設定
            </button>
            <button id="resetBtn" class="btn-danger">
              <i class="fas fa-redo"></i> リセット
            </button>
            <button id="darkModeBtn" class="btn-dark btn-icon">
              <i class="fas fa-moon"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 適用中ルール -->
    <div class="panel">
      <div class="panel-title">
        <span><i class="fas fa-book"></i> 適用中のルール</span>
        <div id="rulesCount">0 件</div>
      </div>
      <div id="rulesList"></div>
    </div>

    <!-- プレイヤーカード -->
    <div id="board"></div>

    <!-- ログパネル -->
    <div class="panel">
      <div class="panel-title">
        <span><i class="fas fa-history"></i> ログ</span>
        <button id="clearLogsBtn" class="btn-danger btn-icon">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div id="logs"></div>
    </div>
  </div>

  <!-- モーダルコンテナ -->
  <div id="modalContainer"></div>

  <script>
    // プレイヤーカード色
    const playerColors = ['player-color-1', 'player-color-2', 'player-color-3', 'player-color-4', 'player-color-5', 'player-color-6'];

    // デフォルト設定
    const defaultPlayers = ["のぞむ", "まどか", "ひかる", "ちえ"];
    const defaultCards = [
      { title: "運命の操作", rule: "指定したプレイヤーの次のターンの進路を操作することができる。" },
      { title: "天災", rule: "全員から500ポイントを没収。" },
      { title: "阻害計画", rule: "次の目的地到達ボーナスを無効化。" },
      { title: "革命の灯", rule: "1位のプレイヤーと自身のポイントを交換する。" },
      { title: "経済成長期", rule: "次回の目的地到達ボーナスが2倍。" },
      { title: "経済不況", rule: "今回の目的地到達ボーナス没収。" },
      { title: "偽善の心", rule: "全員が500ポイントを、最も少ないポイントを持つプレイヤーに贈与。" },
      { title: "強奪", rule: "指定したプレイヤーから1000ポイントを獲得。" },
      { title: "大富豪の恩恵", rule: "全員から1000ポイントずつを獲得。" },
      { title: "破産宣告", rule: "指定したプレイヤーのポイントの半分を没収。" },
      { title: "復讐の一撃", rule: "指定したプレイヤーから2000ポイントを獲得。" },
      { title: "無敵の防御", rule: "他のプレイヤーのカード効果を受けなくなる。" }
    ];

    // データ管理変数
    let players, cards, deck, logs, rules, currentOp;
    let startTime, currentYearStartTime, currentYear, yearTimes;
    let isDarkMode = false;

    // 永続化データをロード
    function loadData() {
      players = JSON.parse(localStorage.getItem("mt_players")) ||
        defaultPlayers.map(name => ({ name, pts: 15000 }));
      cards = JSON.parse(localStorage.getItem("mt_cards")) || defaultCards.slice();
      deck = JSON.parse(localStorage.getItem("mt_deck")) || cards.slice();
      logs = JSON.parse(localStorage.getItem("mt_logs")) || [];
      rules = JSON.parse(localStorage.getItem("mt_rules")) || [];
      document.getElementById("doubleMode").checked =
        JSON.parse(localStorage.getItem("mt_double")) || false;
      isDarkMode = JSON.parse(localStorage.getItem("mt_darkMode")) || false;

      startTime = parseInt(localStorage.getItem("mt_startTime")) || Date.now();
      currentYearStartTime = parseInt(localStorage.getItem("mt_currentYearStartTime")) || startTime;
      currentYear = parseInt(localStorage.getItem("mt_currentYear")) || 1;
      yearTimes = JSON.parse(localStorage.getItem("mt_yearTimes")) || [];

      // ダークモード適用
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeBtn').innerHTML = '<i class="fas fa-sun"></i>';
      }
    }

    // 永続化
    function saveData() {
      localStorage.setItem("mt_players", JSON.stringify(players));
      localStorage.setItem("mt_cards", JSON.stringify(cards));
      localStorage.setItem("mt_deck", JSON.stringify(deck));
      localStorage.setItem("mt_logs", JSON.stringify(logs));
      localStorage.setItem("mt_rules", JSON.stringify(rules));
      localStorage.setItem("mt_double", JSON.stringify(document.getElementById("doubleMode").checked));
      localStorage.setItem("mt_darkMode", JSON.stringify(isDarkMode));
      localStorage.setItem("mt_startTime", startTime);
      localStorage.setItem("mt_currentYearStartTime", currentYearStartTime);
      localStorage.setItem("mt_currentYear", currentYear);
      localStorage.setItem("mt_yearTimes", JSON.stringify(yearTimes));
    }

    // 描画一括
    function render() {
      renderPlayers();
      renderRules();
      renderLogs();
      renderTimers();
    }

    // --- プレイヤーカード描画 ---
    function renderPlayers() {
      const board = document.getElementById("board");
      board.innerHTML = "";
      players.forEach((p, i) => {
        const colorClass = playerColors[i % playerColors.length];
        
        // カードボタンの状態
        const btnCard = deck.length > 0
          ? `<button class="btn-info" onclick="drawCard('${p.name}')"><i class="fas fa-cards"></i> チャンスカード</button>`
          : `<button class="btn-info" disabled><i class="fas fa-cards"></i> カードなし</button>`;
        
        board.innerHTML += `
          <div class="player-card ${colorClass} fade-in">
            <div class="player-header">${p.name}</div>
            <div class="player-body">
              <div class="player-points">${p.pts.toLocaleString()} Pt</div>
                        <div class="player-buttons">
            <button class="btn-primary" onclick="openGive(${i})">
              <i class="fas fa-hand-holding"></i> 渡す
            </button>
            <button class="btn-danger" onclick="openConfiscate(${i})">
              <i class="fas fa-ban"></i> 没収
            </button>
            <button class="btn-success" onclick="openPurchase(${i})">
              <i class="fas fa-plus-circle"></i> Pt購入
            </button>
            <button class="btn-warning" onclick="openGiveAll(${i}, true)">
              <i class="fas fa-users"></i> 全員に
            </button>
            <button class="btn-secondary" onclick="openGiveAll(${i}, false)">
              <i class="fas fa-user"></i> 全員から
            </button>
          </div>
          ${btnCard}
        </div>
      </div>`;
      });
    }

    // --- ルール描画 ---
    function renderRules() {
      document.getElementById('rulesCount').textContent = `${rules.length} 件`;
      const list = document.getElementById("rulesList");
      list.innerHTML = "";
      rules.forEach((r, i) => {
        const cls = r.deleted ? 'rule-entry deleted' : 'rule-entry';
        const by = r.by ? `<div class="rule-by">by ${r.by}</div>` : '';
        list.innerHTML += `
          <div class="${cls}">
            <div class="rule-content">
              <div class="rule-title">${r.title}</div>
              <div class="rule-desc">${r.rule}</div>
              ${by}
            </div>
            <div class="rule-action">
              <button class="btn-danger btn-icon" onclick="delRule(${i})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>`;
      });
    }

    // --- ログ描画 ---
    function renderLogs() {
      const container = document.getElementById("logs");
      container.innerHTML = "";
      logs.slice().reverse().forEach((l, idx) => {
        const isLatest = (idx === 0);
        container.innerHTML += `
          <div class="log-entry${isLatest ? ' latest' : ''}">
            <div class="log-time">${l.time}</div>
            <div class="log-message">${l.desc}</div>
            <div class="log-action">
              <button onclick="delLog(${logs.length - 1 - idx})">
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
          </div>`;
      });
    }

    // --- 年数＆タイマー描画 ---
    function renderTimers() {
      document.getElementById("currentYearDisplay").textContent = `${currentYear}年目`;
      const now = Date.now();
      document.getElementById("totalTimerDisplay").textContent =
        `通算: ${formatTime(now - startTime)}`;
      document.getElementById("yearTimerSingleDisplay").textContent =
        `本年: ${formatTime(now - currentYearStartTime)}`;
    }

    function formatTime(ms) {
      const s = Math.floor(ms / 1000),
            h = Math.floor(s / 3600),
            m = Math.floor((s % 3600) / 60),
            ss = s % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    // --- モーダル共通 ---
    function showModal(html) {
      document.getElementById("modalContainer").innerHTML = `
        <div class="modal-backdrop active" onclick="closeModal()">
          <div class="modal" onclick="event.stopPropagation()">
            ${html}
          </div>
        </div>`;
    }
    function closeModal() {
      document.getElementById("modalContainer").innerHTML = "";
    }

    // --- ポイント操作 ---
    function openGive(idx) {
      const from = players[idx].name;
      const btns = players.filter((_,i) => i!==idx)
        .map(p => `<button class="btn-primary" onclick="chooseGive('${from}','${p.name}')">${p.name}</button>`)
        .join("");
      showModal(`
        <div class="modal-header">
          <div class="modal-title">渡す相手を選択</div>
          <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body player-select">${btns}</div>
      `);
    }

    function chooseGive(from, to) {
      showModal(`
        <div class="modal-header">
          <div class="modal-title">${from} → ${to}</div>
          <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="stepper">
            <button class="btn-primary" onclick="changeAmt(-100)">－</button>
            <div class="stepper-value" id="amt">500</div>
            <button class="btn-primary" onclick="changeAmt(100)">＋</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal()">キャンセル</button>
          <button class="btn-success" onclick="execGive()">実行</button>
        </div>
      `);
      currentOp = { type:"give", from, to, amt:500 };
    }

    function changeAmt(delta) {
      const el = document.getElementById("amt");
      let v = Math.max(0, parseInt(el.textContent) + delta);
      el.textContent = v;
      currentOp.amt = v;
    }

    function execGive() {
      const {from, to, amt} = currentOp;
      players.find(p=>p.name===from).pts -= amt;
      players.find(p=>p.name===to).pts   += amt;
      logs.push({ time: timeStamp(), type:"give", from, to, amt,
                  desc:`${from} → ${to}: ${amt.toLocaleString()} Pt` });
      saveData(); render(); closeModal();
    }

    function openConfiscate(idx) {
      const who = players[idx].name;
      showModal(`
        <div class="modal-header">
          <div class="modal-title">没収: ${who}</div>
          <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">このプレイヤーからポイントを没収しますか？</div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal()">取消</button>
          <button class="btn-danger" onclick="execConfiscate('${who}')">実行</button>
        </div>
      `);
    }

    function execConfiscate(who) {
      const base = 300, dbl = document.getElementById("doubleMode").checked;
      const real = dbl ? base*2 : base;
      players.find(p=>p.name===who).pts -= real;
      logs.push({ time: timeStamp(), type:"confiscate", from:who, to:null, amt:real,
                  desc:`${who} から没収: ${real.toLocaleString()} Pt` });
      saveData(); render(); closeModal();
    }

    function openPurchase(idx) {
      const who = players[idx].name;
      showModal(`
        <div class="modal-header">
          <div class="modal-title">Pt購入: ${who}</div>
          <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="stepper">
            <button class="btn-primary" onclick="changeAmt(-500)">－</button>
            <div class="stepper-value" id="amt">500</div>
            <button class="btn-primary" onclick="changeAmt(500)">＋</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal()">取消</button>
          <button class="btn-success" onclick="execPurchase()">実行</button>
        </div>
      `);
      currentOp = { type:"purchase", from:who, amt:500 };
    }

    function execPurchase() {
      const {from, amt} = currentOp;
      players.find(p=>p.name===from).pts += amt;
      logs.push({ time: timeStamp(), type:"purchase", from, to:null, amt,
                  desc:`${from} が購入: ${amt.toLocaleString()} Pt` });
      saveData(); render(); closeModal();
    }

    function openGiveAll(idx, isGive) {
      const who = players[idx].name;
      showModal(`
        <div class="modal-header">
          <div class="modal-title">${isGive ? '全員に渡す' : '全員から貰う'}: ${who}</div>
          <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="stepper">
            <button class="btn-primary" onclick="changeAmt(-100)">－</button>
            <div class="stepper-value" id="amt">500</div>
            <button class="btn-primary" onclick="changeAmt(100)">＋</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal()">取消</button>
          <button class="btn-success" onclick="execGiveAll()">
            実行
          </button>
        </div>
      `);
      currentOp = { type: isGive ? "giveAll" : "takeAll", from: who, amt: 500 };
    }

    function execGiveAll() {
      const {from, amt, type} = currentOp;
      players.forEach(p => {
        if(p.name === from) return;
        if(type === "giveAll") {
          players.find(x=>x.name===from).pts   -= amt;
          players.find(x=>x.name===p.name).pts += amt;
          logs.push({ time: timeStamp(), type:"give", from, to:p.name, amt,
                      desc:`${from} → ${p.name}: ${amt.toLocaleString()} Pt` });
        } else {
          players.find(x=>x.name===from).pts   += amt;
          players.find(x=>x.name===p.name).pts -= amt;
          logs.push({ time: timeStamp(), type:"give", from:p.name, to:from, amt,
                      desc:`${p.name} → ${from}: ${amt.toLocaleString()} Pt` });
        }
      });
      saveData(); render(); closeModal();
    }

    // --- チャンスカード ---
    function drawCard(who) {
      if(deck.length === 0) return;
      const idx = Math.floor(Math.random()*deck.length);
      const card = deck.splice(idx,1)[0];
      rules.push({ title: card.title, rule: card.rule, by: who, deleted: false });
      logs.push({ time: timeStamp(), type:"card", from:who, to:null, amt:0,
                  desc:`${who} がカード「${card.title}」を引いた` });
      saveData(); render();
    }

    function delRule(i) {
      rules[i].deleted = true;
      saveData(); render();
    }

    // --- ログ取消 + 逆転 ---
    function delLog(i) {
      const l = logs.splice(i,1)[0];
      if(l.type === "give") {
        players.find(p=>p.name===l.from).pts += l.amt;
        players.find(p=>p.name===l.to).pts   -= l.amt;
      } else if(l.type === "confiscate") {
        players.find(p=>p.name===l.from).pts += l.amt;
      } else if(l.type === "purchase") {
        players.find(p=>p.name===l.from).pts -= l.amt;
      } else if(l.type === "card") {
        const title = l.desc.match(/「(.+)」/)[1];
        const idx = rules.findIndex(r=>r.title===title && r.by===l.from);
        if(idx >= 0) rules.splice(idx,1);
      }
      saveData(); render();
    }

    // --- ランキングモーダル ---
    function showRank() {
      const ct = { confiscated:{}, lost:{}, taken:{} };
      logs.forEach(l => {
        if(l.type==="confiscate") {
          ct.confiscated[l.from] = (ct.confiscated[l.from]||0) + l.amt;
        } else if(l.type==="give") {
          ct.lost[l.from] = (ct.lost[l.from]||0) + l.amt;
          ct.taken[l.to]  = (ct.taken[l.to] ||0) + l.amt;
        }
      });
      let html = `<div class="modal-header">
                    <div class="modal-title"><i class="fas fa-trophy"></i> ランキング</div>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                  </div><div class="modal-body">`;
      [["confiscated","没収累計"],["lost","失った累計"],["taken","奪った累計"]]
        .forEach(([k,label])=>{
          html += `<h5>${label}</h5>
                    <table class="rank-table">
                      <tr><th>プレイヤー</th><th>Pt</th></tr>`;
          Object.entries(ct[k]).sort((a,b)=>b[1]-a[1])
            .forEach(([n,a])=>{
              html += `<tr><td>${n}</td><td>${a.toLocaleString()}</td></tr>`;
            });
          html += `</table>`;
        });
      html += `</div>`;
      showModal(html);
    }

    // --- 設定モーダル ---
    function showSettings() {
      let html = `<div class="modal-header">
                    <div class="modal-title"><i class="fas fa-cog"></i> カード設定</div>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="modal-body">`;
      cards.forEach((c,i)=>{
        html += `<div class="card-form">
                   <div class="card-form-fields">
                     <input type="text" class="card-title" value="${c.title}" placeholder="タイトル">
                     <input type="text" class="card-rule"  value="${c.rule}"  placeholder="効果">
                   </div>
                   <button class="btn-danger btn-icon" onclick="delCard(${i})">
                     <i class="fas fa-trash"></i>
                   </button>
                 </div>`;
      });
      html += `<button class="btn-primary" id="addCardBtn"><i class="fas fa-plus"></i> カード追加</button>
               </div>`;
      showModal(html);
      document.getElementById("addCardBtn").onclick = ()=> {
        cards.push({ title:"", rule:"" });
        showSettings();
      };
    }

    function delCard(i) {
      cards.splice(i,1);
      saveData();
      showSettings();
    }

    function saveSettings() {
      document.querySelectorAll(".card-form").forEach((div,i)=>{
        cards[i].title = div.querySelector(".card-title").value;
        cards[i].rule  = div.querySelector(".card-rule").value;
      });
      deck = cards.slice();
      saveData();
      closeModal();
      render();
    }

    // --- 年数進行 ---
    document.getElementById("nextYearBtn").onclick = ()=>{
      const now = Date.now();
      yearTimes.push(now - currentYearStartTime);
      currentYear++;
      currentYearStartTime = now;
      saveData(); render();
    };

    // --- ログクリア ---
    document.getElementById("clearLogsBtn").onclick = ()=>{
      if(!confirm("ログをすべてクリアしますか？")) return;
      logs = [];
      saveData(); render();
    };

    // --- リセット ---
    document.getElementById("resetBtn").onclick = ()=>{
      if(!confirm("全データをリセットしますか？")) return;
      localStorage.clear();
      loadData(); saveData(); render();
    };

    // --- ダークモード切替 ---
    document.getElementById("darkModeBtn").onclick = ()=>{
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      document.getElementById('darkModeBtn').innerHTML =
        isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      saveData();
    };

    // --- ユーティリティ ---
    function timeStamp() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0'),
            mm = String(d.getMinutes()).padStart(2,'0'),
            ss = String(d.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    // 初期化
    document.addEventListener("DOMContentLoaded", ()=>{
      loadData(); render();
      setInterval(renderTimers, 1000);
      document.getElementById("rankBtn").onclick     = showRank;
      document.getElementById("settingsBtn").onclick = showSettings;
      document.getElementById("doubleMode").onchange = ()=>{
        saveData(); render();
      };
    });
  </script>
</body>
</html>

