<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>桃鉄GP 2024 マスターダッシュボード</title>
<style>
/* 基本スタイル */
:root {
  --primary-color: #e74c3c; /* 桃鉄テーマに合わせた赤色 */
  --secondary-color: #3498db; /* アクセントカラー */
  --background-color: #f7f9fc;
  --card-bg: #ffffff;
  --text-color: #333333;
  --border-color: #e0e0e0;
  --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  --button-bg: #f1f1f1;
  --button-active: #d8d8d8;
  --danger-color: #e74c3c;
  --warning-color: #f39c12;
  --success-color: #2ecc71;
  
  /* プレイヤーカラー */
  --player1-color: #e74c3c;
  --player2-color: #3498db;
  --player3-color: #2ecc71;
  --player4-color: #9b59b6;
  
  /* カードの色 */
  --card-front: #f39c12;
  --card-back: #2ecc71;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
  line-height: 1.6;
  padding-bottom: 60px;
}

/* ヘッダースタイル */
header {
  background-color: var(--primary-color);
  color: white;
  padding: 1rem;
  text-align: center;
  box-shadow: var(--shadow);
  position: relative;
}

header h1 {
  margin-bottom: 0.5rem;
  font-size: 1.8rem;
}

nav {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  padding: 0.5rem 0;
}

nav a {
  color: white;
  text-decoration: none;
  padding: 5px 10px;
  border-radius: 4px;
  transition: background-color 0.3s;
}

nav a:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

/* メインレイアウト */
.dashboard-container {
  display: grid;
  grid-template-columns: 3fr 1fr;
  gap: 20px;
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px;
}

/* 左側のコンテンツ（プレイヤーエリアなど） */
.main-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* プレイヤーグリッド */
.players-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

/* プレイヤーカード */
.player-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
  overflow: hidden;
}

.player-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.player-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.player-card h2 {
  color: white;
  text-align: center;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 1.5rem;
  margin: 0;
}

.player-card:nth-child(1) h2 {
  background-color: var(--player1-color);
}

.player-card:nth-child(2) h2 {
  background-color: var(--player2-color);
}

.player-card:nth-child(3) h2 {
  background-color: var(--player3-color);
}

.player-card:nth-child(4) h2 {
  background-color: var(--player4-color);
}

.player-stats {
  display: flex;
  gap: 10px;
}

.stat-badge {
  background-color: #f8f8f8;
  padding: 5px 8px;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: bold;
}

.transfers-count {
  background-color: rgba(52, 152, 219, 0.2);
}

.forfeit-count {
  background-color: rgba(231, 76, 60, 0.2);
}

.player-chips {
  display: flex;
  justify-content: space-around;
  margin: 15px 0;
}

.chip-type {
  text-align: center;
  padding: 10px;
  background-color: #f8f8f8;
  border-radius: 8px;
  width: 30%;
}

.chip-type h3 {
  font-size: 0.9rem;
  margin-bottom: 5px;
  color: #555;
}

.chip-count {
  font-size: 1.3rem;
  font-weight: bold;
}

.black-chip {
  background-color: rgba(52, 73, 94, 0.1);
}

.white-chip {
  background-color: rgba(189, 195, 199, 0.3);
}

.color-chip {
  background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(52, 152, 219, 0.1), rgba(46, 204, 113, 0.1));
}

.player-total {
  text-align: center;
  background: linear-gradient(to right, #f6f6f6, #f0f0f0);
  padding: 10px;
  border-radius: 8px;
  margin: 10px 0;
}

.total-label {
  font-size: 0.9rem;
  color: #777;
}

.total-value {
  font-size: 2rem;
  font-weight: bold;
}

.player-actions {
  display: flex;
  justify-content: space-around;
  margin-top: 15px;
}

.action-btn {
  padding: 8px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.action-btn:hover {
  transform: translateY(-2px);
}

.transfer-btn {
  background-color: rgba(52, 152, 219, 0.2);
  color: #2980b9;
}

.transfer-btn:hover {
  background-color: rgba(52, 152, 219, 0.3);
}

.forfeit-btn {
  background-color: rgba(231, 76, 60, 0.2);
  color: #c0392b;
}

.forfeit-btn:hover {
  background-color: rgba(231, 76, 60, 0.3);
}

/* アクションパネル */
.action-panel {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.panel-title {
  color: var(--primary-color);
  margin-bottom: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-title h3 {
  font-size: 1.3rem;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary-color);
}

input:focus + .toggle-slider {
  box-shadow: 0 0 1px var(--primary-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(30px);
}

.toggle-label {
  margin-right: 10px;
  font-size: 0.9rem;
  font-weight: bold;
}

.transfer-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.form-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.form-group label {
  min-width: 80px;
  font-weight: bold;
}

.form-control {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  flex-grow: 1;
}

.form-control:focus {
  outline: none;
  border-color: var(--secondary-color);
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

/* 改善点: マルチチップセレクター */
.multi-chip-selector {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}

.chip-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.chip-label {
  display: flex;
  align-items: center;
  gap: 5px;
  width: 120px;
}

.chip-icon {
  width: 15px;
  height: 15px;
  border-radius: 50%;
  display: inline-block;
}

.black-icon {
  background-color: #34495e;
}

.white-icon {
  background-color: #ecf0f1;
  border: 1px solid #bdc3c7;
}

.color-icon {
  background: linear-gradient(135deg, #e74c3c, #3498db, #2ecc71);
}

/* 改善点: 直接入力できるよう改善 */
.chip-quantity-control {
  display: flex;
  align-items: center;
  gap: 5px;
}

.chip-quantity-control button {
  width: 30px;
  height: 30px;
  display: flex;
  justify-content: center;
  align-items: center;
  border: none;
  background-color: #f0f0f0;
  border-radius: 50%;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
}

.chip-quantity-control button:hover {
  background-color: #e0e0e0;
}

.chip-quantity {
  width: 50px;
  text-align: center;
  padding: 5px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  font-weight: bold;
}

/* プリセットボタンエリア */
.preset-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 10px;
  margin-bottom: 10px;
}

.preset-btn {
  padding: 8px 10px;
  background-color: #f0f0f0;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s;
}

.preset-btn:hover {
  background-color: #e0e0e0;
}

/* ボタングループ */
.btn-group {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
}

.submit-btn {
  background-color: var(--secondary-color);
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s;
}

.submit-btn:hover {
  background-color: #2980b9;
}

.undo-btn {
  background-color: var(--warning-color);
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s;
}

.undo-btn:hover {
  background-color: #d35400;
}

.reset-btn {
  background-color: var(--danger-color);
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s;
}

.reset-btn:hover {
  background-color: #c0392b;
}

/* 履歴セクション */
.history-section {
  margin-top: 20px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--border-color);
  border-radius: 5px;
}

.history-item {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border-color);
  font-size: 0.9rem;
}

.history-item:last-child {
  border-bottom: none;
}

.history-item.transfer {
  background-color: rgba(52, 152, 219, 0.1);
}

.history-item.forfeit {
  background-color: rgba(231, 76, 60, 0.1);
}

.history-item.undo {
  background-color: rgba(243, 156, 18, 0.1);
}

.no-history {
  padding: 20px;
  text-align: center;
  color: #777;
}

/* 右側のサイドコンテンツ */
.side-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* サマリーカード */
.summary-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.summary-title {
  color: var(--primary-color);
  margin-bottom: 15px;
  font-size: 1.2rem;
  text-align: center;
}

.total-forfeit {
  background: linear-gradient(135deg, var(--primary-color) 0%, #c0392b 100%);
  color: white;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.total-forfeit::before {
  content: "💰";
  position: absolute;
  font-size: 5rem;
  opacity: 0.1;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.forfeit-label {
  font-size: 0.9rem;
}

.forfeit-value {
  font-size: 2rem;
  font-weight: bold;
  margin: 5px 0;
}

.rankings {
  list-style: none;
}

.ranking-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.ranking-item:last-child {
  border-bottom: none;
}

.player-name {
  display: flex;
  align-items: center;
  gap: 8px;
}

.ranking-value {
  font-weight: bold;
}

/* カードエリア */
.active-rules {
  margin-bottom: 20px;
  max-height: 300px;
  overflow-y: auto;
}

.rules-list {
  list-style: none;
}

.rule-item {
  background-color: #f8f8f8;
  padding: 15px;
  border-radius: 5px;
  margin-bottom: 10px;
}

.rule-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.rule-name {
  font-weight: bold;
  color: var(--primary-color);
}

.rule-action {
  color: #777;
  font-size: 0.8rem;
  cursor: pointer;
  background: none;
  border: none;
  padding: 3px 8px;
  border-radius: 3px;
}

.rule-action:hover {
  color: var(--primary-color);
  background-color: rgba(231, 76, 60, 0.1);
}

.rule-description {
  font-size: 0.9rem;
  color: #666;
  line-height: 1.4;
}

.no-rules {
  padding: 15px;
  text-align: center;
  color: #777;
  background-color: #f8f8f8;
  border-radius: 5px;
}

/* カードデッキ */
.card-deck {
  perspective: 1000px;
  height: 280px;
  position: relative;
  cursor: pointer;
}

.deck-label {
  text-align: center;
  margin-bottom: 10px;
  color: #777;
  font-size: 0.9rem;
}

.card {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.8s;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  border-radius: 10px;
}

.card-front {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--card-front);
  background: linear-gradient(135deg, var(--card-front) 0%, #e67e22 100%);
  color: white;
  font-size: 1.8rem;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  overflow: hidden;
}

.card-front:before {
  content: "?";
  font-size: 5rem;
  opacity: 0.2;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.card-front:after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    45deg,
    rgba(255, 255, 255, 0.1),
    rgba(255, 255, 255, 0.1) 10px,
    rgba(255, 255, 255, 0.2) 10px,
    rgba(255, 255, 255, 0.2) 20px
  );
  border-radius: 10px;
}

.cards-remaining {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 0.8rem;
  z-index: 2;
}

/* モーダルスタイル */
.modal-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  position: relative;
  animation: modalFadeIn 0.3s;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(-50px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.modal-title {
  font-size: 1.5rem;
  color: var(--primary-color);
}

.close-modal {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #aaa;
}

.close-modal:hover {
  color: var(--primary-color);
}

.modal-body {
  margin-bottom: 20px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.modal-btn {
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.cancel-btn {
  background-color: #f1f1f1;
  color: #333;
}

.confirm-btn {
  background-color: var(--secondary-color);
  color: white;
}

.danger-btn {
  background-color: var(--danger-color);
  color: white;
}

/* カード表示モーダル */
.card-reveal {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.revealed-card {
  background: var(--card-back);
  background: linear-gradient(135deg, var(--card-back) 0%, #27ae60 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  width: 100%;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.card-title {
  font-size: 1.5rem;
  margin-bottom: 15px;
  position: relative;
  display: inline-block;
}

.card-title:after {
  content: "";
  display: block;
  width: 60%;
  height: 2px;
  background-color: rgba(255, 255, 255, 0.5);
  position: absolute;
  bottom: -5px;
  left: 20%;
}

.card-description {
  font-size: 1.1rem;
  line-height: 1.5;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* トースト通知 */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.toast {
  background-color: white;
  color: var(--text-color);
  padding: 12px 20px;
  border-radius: 5px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 300px;
  animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s;
  animation-fill-mode: forwards;
  opacity: 0;
}

@keyframes toastFadeIn {
  from { opacity: 0; transform: translateX(50px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes toastFadeOut {
  from { opacity: 1; transform: translateX(0); }
  to { opacity: 0; transform: translateX(50px); }
}

.toast-icon {
  font-size: 1.5rem;
}

.toast-success {
  border-left: 4px solid #2ecc71;
}

.toast-warning {
  border-left: 4px solid #f39c12;
}

.toast-error {
  border-left: 4px solid #e74c3c;
}

.toast-info {
  border-left: 4px solid #3498db;
}

.toast-content {
  flex-grow: 1;
}

.toast-title {
  font-weight: bold;
  margin-bottom: 3px;
}

.toast-message {
  font-size: 0.9rem;
}

/* プレイヤー選択ポップアップ */
.transfer-popup {
  display: none;
  position: fixed;
  width: 250px;
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  z-index: 100;
  animation: fadeIn 0.2s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.popup-title {
  padding: 10px 15px;
  background-color: var(--secondary-color);
  color: white;
  border-radius: 10px 10px 0 0;
  font-weight: bold;
}

.popup-content {
  padding: 15px;
}

.player-option {
  padding: 8px 12px;
  margin-bottom: 5px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-option:hover {
  background-color: #f0f0f0;
}

.player-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
}

.player1-color {
  background-color: var(--player1-color);
}

.player2-color {
  background-color: var(--player2-color);
}

.player3-color {
  background-color: var(--player3-color);
}

.player4-color {
  background-color: var(--player4-color);
}

/* レスポンシブ対応 */
@media (max-width: 1200px) {
  .dashboard-container {
    grid-template-columns: 1fr;
  }
  
  .players-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .players-grid {
    grid-template-columns: 1fr;
  }
  
  .player-chips {
    flex-direction: column;
    gap: 10px;
  }
  
  .chip-type {
    width: 100%;
  }
}

/* アニメーション */
.pulse {
  animation: pulse-animation 0.5s;
}

@keyframes pulse-animation {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.shake {
  animation: shake-animation 0.5s;
}

@keyframes shake-animation {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.float {
  animation: float-animation 3s infinite ease-in-out;
}

@keyframes float-animation {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>
</head>
<body>
<header>
  <h1>桃鉄GP マスターダッシュボード</h1>
  <nav>
    <a href="index.html">チップカウンター</a>
    <a href="rules.html">大会ルール</a>
    <a href="cards.html">チャンスカード</a>
    <a href="roulette.html">抽選ルーレット</a>
    <a href="forfeit-counter.html">没収ポイント</a>
    <a href="hidden-destination.html">裏目的地</a>
  </nav>
</header>

<div class="dashboard-container">
  <!-- 左側のメインコンテンツ -->
  <div class="main-content">
    <!-- プレイヤーグリッド -->
    <div class="players-grid">
      <!-- プレイヤー1 -->
      <div class="player-card" data-player="nozomu">
        <div class="player-header">
          <h2>のぞむ</h2>
          <div class="player-stats">
            <span class="stat-badge transfers-count" title="ポイント移動回数">0</span>
            <span class="stat-badge forfeit-count" title="没収回数">0</span>
          </div>
        </div>
        <div class="player-chips">
          <div class="chip-type black-chip">
            <h3>黒チップ</h3>
            <div class="chip-count" data-chip-type="black">3</div>
          </div>
          <div class="chip-type white-chip">
            <h3>白チップ</h3>
            <div class="chip-count" data-chip-type="white">6</div>
          </div>
          <div class="chip-type color-chip">
            <h3>カラーチップ</h3>
            <div class="chip-count" data-chip-type="color">30</div>
          </div>
        </div>
        <div class="player-total">
          <div class="total-label">総資産</div>
          <div class="total-value" data-total>15,000 Pt</div>
        </div>
        <div class="player-actions">
          <button class="action-btn transfer-btn" data-action="transfer">
            <span>移動</span>
          </button>
          <button class="action-btn forfeit-btn" data-action="forfeit">
            <span>没収</span>
          </button>
        </div>
      </div>
      
      <!-- プレイヤー2 -->
      <div class="player-card" data-player="madoka">
        <div class="player-header">
          <h2>まどか</h2>
          <div class="player-stats">
            <span class="stat-badge transfers-count" title="ポイント移動回数">0</span>
            <span class="stat-badge forfeit-count" title="没収回数">0</span>
          </div>
        </div>
        <div class="player-chips">
          <div class="chip-type black-chip">
            <h3>黒チップ</h3>
            <div class="chip-count" data-chip-type="black">3</div>
          </div>
          <div class="chip-type white-chip">
            <h3>白チップ</h3>
            <div class="chip-count" data-chip-type="white">6</div>
          </div>
          <div class="chip-type color-chip">
            <h3>カラーチップ</h3>
            <div class="chip-count" data-chip-type="color">30</div>
          </div>
        </div>
        <div class="player-total">
          <div class="total-label">総資産</div>
          <div class="total-value" data-total>15,000 Pt</div>
        </div>
        <div class="player-actions">
          <button class="action-btn transfer-btn" data-action="transfer">
            <span>移動</span>
          </button>
          <button class="action-btn forfeit-btn" data-action="forfeit">
            <span>没収</span>
          </button>
        </div>
      </div>
      
      <!-- プレイヤー3 -->
      <div class="player-card" data-player="hikaru">
        <div class="player-header">
          <h2>ひかる</h2>
          <div class="player-stats">
            <span class="stat-badge transfers-count" title="ポイント移動回数">0</span>
            <span class="stat-badge forfeit-count" title="没収回数">0</span>
          </div>
        </div>
        <div class="player-chips">
          <div class="chip-type black-chip">
            <h3>黒チップ</h3>
            <div class="chip-count" data-chip-type="black">3</div>
          </div>
          <div class="chip-type white-chip">
            <h3>白チップ</h3>
            <div class="chip-count" data-chip-type="white">6</div>
          </div>
          <div class="chip-type color-chip">
            <h3>カラーチップ</h3>
            <div class="chip-count" data-chip-type="color">30</div>
          </div>
        </div>
        <div class="player-total">
          <div class="total-label">総資産</div>
          <div class="total-value" data-total>15,000 Pt</div>
        </div>
        <div class="player-actions">
          <button class="action-btn transfer-btn" data-action="transfer">
            <span>移動</span>
          </button>
          <button class="action-btn forfeit-btn" data-action="forfeit">
            <span>没収</span>
          </button>
        </div>
      </div>
      
      <!-- プレイヤー4 -->
      <div class="player-card" data-player="chie">
        <div class="player-header">
          <h2>ちえ</h2>
          <div class="player-stats">
            <span class="stat-badge transfers-count" title="ポイント移動回数">0</span>
            <span class="stat-badge forfeit-count" title="没収回数">0</span>
          </div>
        </div>
        <div class="player-chips">
          <div class="chip-type black-chip">
            <h3>黒チップ</h3>
            <div class="chip-count" data-chip-type="black">3</div>
          </div>
          <div class="chip-type white-chip">
            <h3>白チップ</h3>
            <div class="chip-count" data-chip-type="white">6</div>
          </div>
          <div class="chip-type color-chip">
            <h3>カラーチップ</h3>
            <div class="chip-count" data-chip-type="color">30</div>
          </div>
        </div>
        <div class="player-total">
          <div class="total-label">総資産</div>
          <div class="total-value" data-total>15,000 Pt</div>
        </div>
        <div class="player-actions">
          <button class="action-btn transfer-btn" data-action="transfer">
            <span>移動</span>
          </button>
          <button class="action-btn forfeit-btn" data-action="forfeit">
            <span>没収</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- アクションパネル -->
    <div class="action-panel">
      <div class="panel-title">
        <h3>ポイント操作</h3>
        <div style="display: flex; align-items: center;">
          <span class="toggle-label">倍モード</span>
          <label class="toggle-switch">
            <input type="checkbox" id="double-mode-toggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="transfer-form">
        <div class="form-group">
          <label>操作タイプ</label>
          <select id="action-type" class="form-control">
            <option value="transfer">プレイヤー間移動</option>
            <option value="forfeit">没収</option>
          </select>
        </div>
        <div class="form-group" id="from-player-group">
          <label>From</label>
          <select id="from-player" class="form-control">
            <option value="nozomu">のぞむ</option>
            <option value="madoka">まどか</option>
            <option value="hikaru">ひかる</option>
            <option value="chie">ちえ</option>
          </select>
        </div>
        <div class="form-group" id="to-player-group">
          <label>To</label>
          <select id="to-player" class="form-control">
            <option value="nozomu">のぞむ</option>
            <option value="madoka">まどか</option>
            <option value="hikaru">ひかる</option>
            <option value="chie">ちえ</option>
            <option value="forfeit">没収</option>
          </select>
        </div>
        <div class="form-group">
          <label>チップ選択</label>
        </div>
        
        <!-- プリセットボタン -->
        <div class="preset-buttons">
          <button class="preset-btn" data-preset="300">300Pt</button>
          <button class="preset-btn" data-preset="500">500Pt</button>
          <button class="preset-btn" data-preset="1000">1,000Pt</button>
          <button class="preset-btn" data-preset="1500">1,500Pt</button>
          <button class="preset-btn" data-preset="3000">3,000Pt</button>
          <button class="preset-btn" data-preset="5000">5,000Pt</button>
        </div>
        
        <div class="multi-chip-selector">
          <div class="chip-row">
            <div class="chip-label">
              <span class="chip-icon black-icon"></span>
              <span>黒チップ (1000Pt)</span>
            </div>
            <div class="chip-quantity-control">
              <button class="decrease-btn" data-chip-type="black">-</button>
              <input type="number" class="chip-quantity" id="black-quantity" value="0" min="0">
              <button class="increase-btn" data-chip-type="black">+</button>
            </div>
          </div>
          <div class="chip-row">
            <div class="chip-label">
              <span class="chip-icon white-icon"></span>
              <span>白チップ (500Pt)</span>
            </div>
            <div class="chip-quantity-control">
              <button class="decrease-btn" data-chip-type="white">-</button>
              <input type="number" class="chip-quantity" id="white-quantity" value="0" min="0">
              <button class="increase-btn" data-chip-type="white">+</button>
            </div>
          </div>
          <div class="chip-row">
            <div class="chip-label">
              <span class="chip-icon color-icon"></span>
              <span>カラーチップ (300Pt)</span>
            </div>
            <div class="chip-quantity-control">
              <button class="decrease-btn" data-chip-type="color">-</button>
              <input type="number" class="chip-quantity" id="color-quantity" value="0" min="0">
              <button class="increase-btn" data-chip-type="color">+</button>
            </div>
          </div>
          <div class="chip-row" style="margin-top: 10px;">
            <div class="chip-label">合計ポイント:</div>
            <div id="total-points">0 Pt</div>
          </div>
        </div>
        
        <div class="btn-group">
          <button id="undo-btn" class="undo-btn">取消</button>
          <button id="submit-action" class="submit-btn">実行</button>
          <button id="reset-btn" class="reset-btn">リセット</button>
        </div>
      </div>
      <div class="history-section">
        <div class="no-history">まだ履歴はありません</div>
      </div>
    </div>
  </div>
  
  <!-- 右側のサイドコンテンツ -->
  <div class="side-content">
    <!-- サマリーカード -->
    <div class="summary-card">
      <h3 class="summary-title">統計</h3>
      <div class="total-forfeit">
        <div class="forfeit-label">没収ポイント合計</div>
        <div class="forfeit-value" id="total-forfeit">0 Pt</div>
      </div>
      <h4 style="margin-bottom: 10px;">取引ランキング</h4>
      <ul class="rankings" id="transfer-ranking">
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player1-color"></span>
            <span>のぞむ</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player2-color"></span>
            <span>まどか</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player3-color"></span>
            <span>ひかる</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player4-color"></span>
            <span>ちえ</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
      </ul>
      
      <h4 style="margin: 15px 0 10px;">没収ランキング</h4>
      <ul class="rankings" id="forfeit-ranking">
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player1-color"></span>
            <span>のぞむ</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player2-color"></span>
            <span>まどか</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player3-color"></span>
            <span>ひかる</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
        <li class="ranking-item">
          <div class="player-name">
            <span class="player-indicator player4-color"></span>
            <span>ちえ</span>
          </div>
          <div class="ranking-value">0</div>
        </li>
      </ul>
    </div>
    
    <!-- カードエリア -->
    <div class="summary-card">
      <h3 class="summary-title">適用中のルール</h3>
      <div class="active-rules">
        <div class="no-rules" id="no-rules-message">現在適用中のルールはありません</div>
        <ul class="rules-list" id="rules-list"></ul>
      </div>
      <div class="deck-label">チャンスカードを引く</div>
      <div class="card-deck" id="card-deck">
        <div class="card">
          <div class="card-front"></div>
        </div>
        <div class="cards-remaining" id="cards-remaining">12枚</div>
      </div>
    </div>
  </div>
</div>

<!-- プレイヤー選択ポップアップ -->
<div class="transfer-popup" id="player-popup">
  <div class="popup-title">移動先を選択</div>
  <div class="popup-content" id="popup-content">
    <!-- オプションはJSで動的に追加 -->
  </div>
</div>

<!-- 移動確認モーダル -->
<div class="modal-container" id="transfer-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ポイント移動確認</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body" id="transfer-modal-body">
      <p>プレイヤー間でチップを移動します。</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn cancel-btn">キャンセル</button>
      <button class="modal-btn confirm-btn" id="confirm-transfer">実行</button>
    </div>
  </div>
</div>

<!-- 没収確認モーダル -->
<div class="modal-container" id="forfeit-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ポイント没収確認</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body" id="forfeit-modal-body">
      <p>プレイヤーからチップを没収します。</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn cancel-btn">キャンセル</button>
      <button class="modal-btn confirm-btn" id="confirm-forfeit">実行</button>
    </div>
  </div>
</div>

<!-- カード表示モーダル -->
<div class="modal-container" id="card-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">チャンスカード</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="card-reveal">
        <div class="revealed-card">
          <div class="card-title" id="card-title">カードタイトル</div>
          <div class="card-description" id="card-description">カードの効果説明がここに表示されます。</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn cancel-btn" id="discard-card">破棄</button>
      <button class="modal-btn confirm-btn" id="apply-card">適用</button>
    </div>
  </div>
</div>

<!-- リセット確認モーダル -->
<div class="modal-container" id="reset-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">全てリセット</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <p>全てのデータをリセットします。この操作は取り消せません。</p>
      <p style="color: var(--danger-color); margin-top: 10px; font-weight: bold;">本当にリセットしますか？</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn cancel-btn">キャンセル</button>
      <button class="modal-btn danger-btn" id="confirm-reset">リセット実行</button>
    </div>
  </div>
</div>

<!-- トースト通知 -->
<div class="toast-container" id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // チップの値を定義
  const CHIP_VALUES = {
    black: 1000,
    white: 500,
    color: 300
  };
  
  // 初期プレイヤーデータの定義（リセット用に保持）
  const INITIAL_PLAYER_DATA = {
    nozomu: {
      name: "のぞむ",
      chips: { black: 3, white: 6, color: 30 },
      total: 15000,
      transferCount: 0,
      forfeitCount: 0
    },
    madoka: {
      name: "まどか",
      chips: { black: 3, white: 6, color: 30 },
      total: 15000,
      transferCount: 0,
      forfeitCount: 0
    },
    hikaru: {
      name: "ひかる",
      chips: { black: 3, white: 6, color: 30 },
      total: 15000,
      transferCount: 0,
      forfeitCount: 0
    },
    chie: {
      name: "ちえ",
      chips: { black: 3, white: 6, color: 30 },
      total: 15000,
      transferCount: 0,
      forfeitCount: 0
    }
  };
  
  // プレイヤーデータ
  let players = JSON.parse(JSON.stringify(INITIAL_PLAYER_DATA)); // ディープコピー
  
  // 没収ポイント合計
  let totalForfeit = 0;
  
  // 倍モードフラグ
  let doubleMode = false;
  
  // チャンスカードデータ
  const cards = [
    { title: "運命の操作", rule: "指定したプレイヤーの次のターンの進路を操作することができる。" },
    { title: "天災", rule: "全員から黒チップ1枚を没収。" },
    { title: "阻害計画", rule: "次の目的地到達ボーナスを無効化。" },
    { title: "革命の灯", rule: "1位のプレイヤーと自身のチップを交換する。" },
    { title: "経済成長期", rule: "次回の目的地到達ボーナスが2倍。" },
    { title: "経済不況", rule: "今回の目的地到達ボーナス没収。" },
    { title: "偽善の心", rule: "全員が白チップ1枚を、最も少ないチップを持つプレイヤーに全て贈与。" },
    { title: "強奪", rule: "指定したプレイヤーから黒チップ1枚を獲得。" },
    { title: "大富豪の恩恵", rule: "全員から黒チップ1枚ずつを獲得。" },
    { title: "破産宣告", rule: "指定したプレイヤーの全ての黒チップを没収。" },
    { title: "復讐の一撃", rule: "指定したプレイヤーから黒チップ2枚を獲得。" },
    { title: "無敵の防御", rule: "他のプレイヤーのカード効果を受けなくなる。" }
  ];
  
  // カードをシャッフル
  let shuffledCards = [...cards].sort(() => Math.random() - 0.5);
  let activeRules = [];
  
  // 履歴データ
  let history = [];
  
  // 状態の履歴（Undo用）
  let stateHistory = [];
  
  // 選択中のプレイヤー情報
  let selectedFromPlayer = null;
  let selectedToPlayer = null;
  
  // 選択中のチップ情報
  let selectedChips = {
    black: 0,
    white: 0,
    color: 0
  };
  
  // DOM要素の参照を取得
  const actionTypeSelect = document.getElementById('action-type');
  const fromPlayerSelect = document.getElementById('from-player');
  const toPlayerSelect = document.getElementById('to-player');
  const blackQuantity = document.getElementById('black-quantity');
  const whiteQuantity = document.getElementById('white-quantity');
  const colorQuantity = document.getElementById('color-quantity');
  const totalPoints = document.getElementById('total-points');
  const submitActionBtn = document.getElementById('submit-action');
  const undoBtn = document.getElementById('undo-btn');
  const resetBtn = document.getElementById('reset-btn');
  const doubleModeToggle = document.getElementById('double-mode-toggle');
  const fromPlayerGroup = document.getElementById('from-player-group');
  const toPlayerGroup = document.getElementById('to-player-group');
  const historySection = document.querySelector('.history-section');
  const transferModal = document.getElementById('transfer-modal');
  const forfeitModal = document.getElementById('forfeit-modal');
  const resetModal = document.getElementById('reset-modal');
  const transferModalBody = document.getElementById('transfer-modal-body');
  const forfeitModalBody = document.getElementById('forfeit-modal-body');
  const confirmTransferBtn = document.getElementById('confirm-transfer');
  const confirmForfeitBtn = document.getElementById('confirm-forfeit');
  const confirmResetBtn = document.getElementById('confirm-reset');
  const totalForfeitDisplay = document.getElementById('total-forfeit');
  const transferRanking = document.getElementById('transfer-ranking');
  const forfeitRanking = document.getElementById('forfeit-ranking');
  const cardDeck = document.getElementById('card-deck');
  const cardsRemaining = document.getElementById('cards-remaining');
  const cardModal = document.getElementById('card-modal');
  const cardTitle = document.getElementById('card-title');
  const cardDescription = document.getElementById('card-description');
  const applyCardBtn = document.getElementById('apply-card');
  const discardCardBtn = document.getElementById('discard-card');
  const rulesList = document.getElementById('rules-list');
  const noRulesMessage = document.getElementById('no-rules-message');
  const toastContainer = document.getElementById('toast-container');
  const playerPopup = document.getElementById('player-popup');
  const popupContent = document.getElementById('popup-content');
  const presetButtons = document.querySelectorAll('.preset-btn');
  
  // 現在選択中のカード
  let currentCard = null;
  
  // モーダルを閉じるボタンのイベントリスナー
  document.querySelectorAll('.close-modal, .cancel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.modal-container').forEach(modal => {
        modal.style.display = 'none';
      });
  
  // リセットボタンのイベントリスナー
  resetBtn.addEventListener('click', function() {
    resetModal.style.display = 'flex';
  });
  
  // リセット確認ボタンのイベントリスナー
  confirmResetBtn.addEventListener('click', function() {
    resetAll();
    resetModal.style.display = 'none';
  });
  
  // 取消ボタンのイベントリスナー
  undoBtn.addEventListener('click', function() {
    undoLastAction();
  });
    });
  });
  
  // プレイヤーのチップ数と総資産を更新する関数
  function updatePlayerDisplay(playerId) {
    const player = players[playerId];
    const playerCard = document.querySelector(`.player-card[data-player="${playerId}"]`);
    
    if (playerCard) {
      // チップ数を更新
      Object.keys(player.chips).forEach(chipType => {
        const chipElement = playerCard.querySelector(`[data-chip-type="${chipType}"]`);
        if (chipElement) {
          chipElement.textContent = player.chips[chipType];
        }
      });
      
      // 総資産を更新
      const totalElement = playerCard.querySelector('[data-total]');
      if (totalElement) {
        totalElement.textContent = `${player.total.toLocaleString()} Pt`;
      }
      
      // 移動回数と没収回数を更新
      const transfersCountElement = playerCard.querySelector('.transfers-count');
      const forfeitCountElement = playerCard.querySelector('.forfeit-count');
      
      if (transfersCountElement) {
        transfersCountElement.textContent = player.transferCount;
      }
      
      if (forfeitCountElement) {
        forfeitCountElement.textContent = player.forfeitCount;
      }
    }
  }
  
  // 総資産を計算する関数
  function calculateTotal(player) {
    let total = 0;
    Object.keys(player.chips).forEach(chipType => {
      total += player.chips[chipType] * CHIP_VALUES[chipType];
    });
    return total;
  }
  
  // 没収ポイント合計を更新する関数
  function updateTotalForfeit() {
    totalForfeitDisplay.textContent = `${totalForfeit.toLocaleString()} Pt`;
  }
  
  // ランキングを更新する関数
  function updateRankings() {
    // 取引ランキング
    const transferEntries = Object.entries(players).map(([id, player]) => ({ id, count: player.transferCount }));
    transferEntries.sort((a, b) => b.count - a.count);
    
    const transferItems = transferRanking.querySelectorAll('.ranking-item');
    transferEntries.forEach((entry, index) => {
      const item = transferItems[index];
      if (item) {
        const playerName = item.querySelector('.player-name span:last-child');
        const rankingValue = item.querySelector('.ranking-value');
        
        if (playerName) {
          playerName.textContent = players[entry.id].name;
        }
        
        if (rankingValue) {
          rankingValue.textContent = entry.count;
        }
      }
    });
    
    // 没収ランキング
    const forfeitEntries = Object.entries(players).map(([id, player]) => ({ id, count: player.forfeitCount }));
    forfeitEntries.sort((a, b) => b.count - a.count);
    
    const forfeitItems = forfeitRanking.querySelectorAll('.ranking-item');
    forfeitEntries.forEach((entry, index) => {
      const item = forfeitItems[index];
      if (item) {
        const playerName = item.querySelector('.player-name span:last-child');
        const rankingValue = item.querySelector('.ranking-value');
        
        if (playerName) {
          playerName.textContent = players[entry.id].name;
        }
        
        if (rankingValue) {
          rankingValue.textContent = entry.count;
        }
      }
    });
  }
  
  // 履歴を追加する関数
  function addHistory(action, from, to, chips, points) {
    const now = new Date();
    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    
    let message = '';
    if (action === 'transfer') {
      // チップの内訳テキストを作成
      let chipDetails = [];
      Object.keys(chips).forEach(chipType => {
        if (chips[chipType] > 0) {
          const name = getChipTypeName(chipType);
          chipDetails.push(`${name} ×${chips[chipType]}`);
        }
      });
      
      message = `${timeString} - ${players[from].name} → ${players[to].name}: ${chipDetails.join(', ')} (${points.toLocaleString()} Pt)`;
    } else if (action === 'forfeit') {
      // チップの内訳テキストを作成
      let chipDetails = [];
      Object.keys(chips).forEach(chipType => {
        if (chips[chipType] > 0) {
          const name = getChipTypeName(chipType);
          chipDetails.push(`${name} ×${chips[chipType]}`);
        }
      });
      
      message = `${timeString} - ${players[from].name} から没収: ${chipDetails.join(', ')} (${points.toLocaleString()} Pt)`;
    } else if (action === 'undo') {
      message = `${timeString} - 取消: ${from}`;
    }
    
    const historyItem = document.createElement('div');
    historyItem.classList.add('history-item', action);
    historyItem.textContent = message;
    
    // 「まだ履歴はありません」メッセージを削除
    const noHistory = historySection.querySelector('.no-history');
    if (noHistory) {
      noHistory.remove();
    }
    
    // 先頭に追加
    if (historySection.firstChild) {
      historySection.insertBefore(historyItem, historySection.firstChild);
    } else {
      historySection.appendChild(historyItem);
    }
    
    // 履歴配列に追加
    history.unshift({
      action,
      from,
      to,
      chips,
      points,
      timestamp: now.getTime()
    });
    
    // 履歴の数を制限（最新20件のみ）
    if (historySection.children.length > 20) {
      historySection.removeChild(historySection.lastChild);
    }
    
    // ローカルストレージに保存
    saveState();
  }
  
  // 現在の状態を履歴に保存（Undo用）
  function saveStateToHistory() {
    // 現在の状態をディープコピー
    const currentState = {
      players: JSON.parse(JSON.stringify(players)),
      totalForfeit: totalForfeit,
      history: [...history],
      activeRules: [...activeRules]
    };
    
    stateHistory.push(currentState);
    
    // 履歴が長すぎる場合は古いものを削除
    if (stateHistory.length > 20) {
      stateHistory.shift();
    }
  }
  
  // 前の状態に戻す（Undo）
  function undoLastAction() {
    if (stateHistory.length === 0) {
      showToast('warning', '取消不可', '取り消せる操作がありません。');
      return;
    }
    
    // 最新の状態を取得
    const previousState = stateHistory.pop();
    
    // 状態を復元
    players = previousState.players;
    totalForfeit = previousState.totalForfeit;
    history = previousState.history;
    activeRules = previousState.activeRules;
    
    // 画面表示を更新
    Object.keys(players).forEach(playerId => {
      updatePlayerDisplay(playerId);
    });
    
    updateTotalForfeit();
    updateRankings();
    updateActiveRules();
    
    // 履歴表示を更新
    historySection.innerHTML = '';
    if (history.length === 0) {
      historySection.innerHTML = '<div class="no-history">まだ履歴はありません</div>';
    } else {
      history.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.classList.add('history-item', item.action);
        
        const timeString = new Date(item.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        let message = '';
        if (item.action === 'transfer') {
          // チップの内訳テキストを作成
          let chipDetails = [];
          Object.keys(item.chips).forEach(chipType => {
            if (item.chips[chipType] > 0) {
              const name = getChipTypeName(chipType);
              chipDetails.push(`${name} ×${item.chips[chipType]}`);
            }
          });
          
          message = `${timeString} - ${players[item.from].name} → ${players[item.to].name}: ${chipDetails.join(', ')} (${item.points.toLocaleString()} Pt)`;
        } else if (item.action === 'forfeit') {
          // チップの内訳テキストを作成
          let chipDetails = [];
          Object.keys(item.chips).forEach(chipType => {
            if (item.chips[chipType] > 0) {
              const name = getChipTypeName(chipType);
              chipDetails.push(`${name} ×${item.chips[chipType]}`);
            }
          });
          
          message = `${timeString} - ${players[item.from].name} から没収: ${chipDetails.join(', ')} (${item.points.toLocaleString()} Pt)`;
        } else if (item.action === 'undo') {
          message = `${timeString} - 取消: ${item.from}`;
        }
        
        historyItem.textContent = message;
        historySection.appendChild(historyItem);
      });
    }
    
    // 通知
    showToast('warning', '操作取消', '最後の操作を取り消しました。');
    
    // ローカルストレージに保存
    saveState();
  }
  
  // すべてリセットする
  function resetAll() {
    // すべてを初期状態に戻す
    players = JSON.parse(JSON.stringify(INITIAL_PLAYER_DATA));
    totalForfeit = 0;
    doubleMode = false;
    history = [];
    stateHistory = [];
    activeRules = [];
    shuffledCards = [...cards].sort(() => Math.random() - 0.5);
    
    // UI更新
    Object.keys(players).forEach(playerId => {
      updatePlayerDisplay(playerId);
    });
    
    updateTotalForfeit();
    updateRankings();
    updateActiveRules();
    updateRemainingCards();
    
    // 選択チップをリセット
    resetChipSelection();
    
    // 履歴表示をクリア
    historySection.innerHTML = '<div class="no-history">まだ履歴はありません</div>';
    
    // 倍モードトグルをリセット
    doubleModeToggle.checked = false;
    
    // 通知
    showToast('info', 'リセット完了', 'すべてのデータを初期状態に戻しました。');
    
    // ローカルストレージに保存
    saveState();
  }
  
  // プレイヤー間のポイント移動を実行する関数
  function executeTransfer(fromPlayer, toPlayer, chips) {
    // 現在の状態を履歴に保存
    saveStateToHistory();
    
    // チップが選択されているか確認
    const totalChips = Object.values(chips).reduce((sum, count) => sum + count, 0);
    if (totalChips === 0) {
      showToast('error', 'エラー', 'チップが選択されていません。');
      return false;
    }
    
    // チップが十分にあるか確認
    for (const chipType in chips) {
      if (players[fromPlayer].chips[chipType] < chips[chipType]) {
        showToast('error', 'エラー', `${players[fromPlayer].name}の${getChipTypeName(chipType)}が不足しています。`);
        return false;
      }
    }
    
    // ポイント計算
    let totalPoints = 0;
    Object.keys(chips).forEach(chipType => {
      totalPoints += CHIP_VALUES[chipType] * chips[chipType];
    });
    
    // チップを移動
    Object.keys(chips).forEach(chipType => {
      if (chips[chipType] > 0) {
        players[fromPlayer].chips[chipType] -= chips[chipType];
        players[toPlayer].chips[chipType] += chips[chipType];
      }
    });
    
    // 総資産を再計算
    players[fromPlayer].total = calculateTotal(players[fromPlayer]);
    players[toPlayer].total = calculateTotal(players[toPlayer]);
    
    // 移動回数をインクリメント
    players[fromPlayer].transferCount++;
    players[toPlayer].transferCount++;
    
    // 表示を更新
    updatePlayerDisplay(fromPlayer);
    updatePlayerDisplay(toPlayer);
    updateRankings();
    
    // 履歴に追加
    addHistory('transfer', fromPlayer, toPlayer, chips, totalPoints);
    
    // 通知
    showToast('success', 'ポイント移動', `${players[fromPlayer].name}から${players[toPlayer].name}へ${totalPoints.toLocaleString()} Pt移動しました。`);
    
    // チップ選択をリセット
    resetChipSelection();
    
    return true;
  }
  
  // プレイヤーからのポイント没収を実行する関数
  function executeForfeit(fromPlayer, chips) {
    // 現在の状態を履歴に保存
    saveStateToHistory();
    
    // チップが選択されているか確認
    const totalChips = Object.values(chips).reduce((sum, count) => sum + count, 0);
    if (totalChips === 0) {
      showToast('error', 'エラー', 'チップが選択されていません。');
      return false;
    }
    
    // コピーを作成
    const adjustedChips = {...chips};
    
    // 倍モードの場合はチップ数を倍にする
    if (doubleMode) {
      Object.keys(adjustedChips).forEach(chipType => {
        adjustedChips[chipType] *= 2;
      });
    }
    
    // チップが十分にあるか確認
    for (const chipType in adjustedChips) {
      if (players[fromPlayer].chips[chipType] < adjustedChips[chipType]) {
        showToast('error', 'エラー', `${players[fromPlayer].name}の${getChipTypeName(chipType)}が不足しています。`);
        return false;
      }
    }
    
    // ポイント計算
    let totalPoints = 0;
    Object.keys(adjustedChips).forEach(chipType => {
      totalPoints += CHIP_VALUES[chipType] * adjustedChips[chipType];
    });
    
    // チップを没収
    Object.keys(adjustedChips).forEach(chipType => {
      if (adjustedChips[chipType] > 0) {
        players[fromPlayer].chips[chipType] -= adjustedChips[chipType];
      }
    });
    
    totalForfeit += totalPoints;
    
    // 総資産を再計算
    players[fromPlayer].total = calculateTotal(players[fromPlayer]);
    
    // 没収回数をインクリメント
    players[fromPlayer].forfeitCount++;
    
    // 表示を更新
    updatePlayerDisplay(fromPlayer);
    updateTotalForfeit();
    updateRankings();
    
    // 履歴に追加
    addHistory('forfeit', fromPlayer, 'forfeit', adjustedChips, totalPoints);
    
    // 通知
    showToast('warning', 'ポイント没収', `${players[fromPlayer].name}から${totalPoints.toLocaleString()} Ptを没収しました。`);
    
    // チップ選択をリセット
    resetChipSelection();
    
    return true;
  }
  
  // チップタイプの日本語名を取得する関数
  function getChipTypeName(chipType) {
    switch (chipType) {
      case 'black':
        return '黒チップ';
      case 'white':
        return '白チップ';
      case 'color':
        return 'カラーチップ';
      default:
        return chipType;
    }
  }
  
  // トースト通知を表示する関数
  function showToast(type, title, message) {
    const toast = document.createElement('div');
    toast.classList.add('toast', `toast-${type}`);
    
    let icon = '';
    switch (type) {
      case 'success':
        icon = '✅';
        break;
      case 'warning':
        icon = '⚠️';
        break;
      case 'error':
        icon = '❌';
        break;
      default:
        icon = 'ℹ️';
    }
    
    toast.innerHTML = `
      <div class="toast-icon">${icon}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // フェードイン
    setTimeout(() => {
      toast.style.opacity = '1';
    }, 10);
    
    // 3秒後に削除
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
  
  // 選択されたチップの合計ポイントを計算する関数
  function calculateSelectedPoints() {
    let total = 0;
    Object.keys(selectedChips).forEach(chipType => {
      total += selectedChips[chipType] * CHIP_VALUES[chipType];
    });
    return total;
  }
  
  // チップ選択をリセットする関数
  function resetChipSelection() {
    selectedChips = {
      black: 0,
      white: 0,
      color: 0
    };
    
    blackQuantity.value = '0';
    whiteQuantity.value = '0';
    colorQuantity.value = '0';
    totalPoints.textContent = '0 Pt';
  }
  
  // プリセットボタンでチップを設定する関数
  function setChipsByTotal(totalValue) {
    resetChipSelection();
    
    // まず黒チップを最大限使用
    const blackCount = Math.floor(totalValue / CHIP_VALUES.black);
    selectedChips.black = blackCount;
    totalValue -= blackCount * CHIP_VALUES.black;
    
    // 次に白チップを最大限使用
    const whiteCount = Math.floor(totalValue / CHIP_VALUES.white);
    selectedChips.white = whiteCount;
    totalValue -= whiteCount * CHIP_VALUES.white;
    
    // 残りをカラーチップで調整
    const colorCount = Math.ceil(totalValue / CHIP_VALUES.color);
    selectedChips.color = colorCount;
    
    // 表示更新
    blackQuantity.value = selectedChips.black.toString();
    whiteQuantity.value = selectedChips.white.toString();
    colorQuantity.value = selectedChips.color.toString();
    totalPoints.textContent = `${calculateSelectedPoints().toLocaleString()} Pt`;
  }
  
  // プレイヤー選択ポップアップを表示する関数
  function showPlayerPopup(fromPlayerId, buttonElement) {
    const buttonRect = buttonElement.getBoundingClientRect();
    
    // ポップアップの位置を設定
    playerPopup.style.top = `${buttonRect.bottom + window.scrollY + 10}px`;
    playerPopup.style.left = `${buttonRect.left + window.scrollX}px`;
    
    // ポップアップのコンテンツをクリア
    popupContent.innerHTML = '';
    
    // プレイヤーオプションを追加（送信元プレイヤーは除く）
    Object.keys(players).forEach(playerId => {
      if (playerId !== fromPlayerId) {
        const option = document.createElement('div');
        option.classList.add('player-option');
        
        let indicatorClass = '';
        if (playerId === 'nozomu') indicatorClass = 'player1-color';
        else if (playerId === 'madoka') indicatorClass = 'player2-color';
        else if (playerId === 'hikaru') indicatorClass = 'player3-color';
        else if (playerId === 'chie') indicatorClass = 'player4-color';
        
        option.innerHTML = `
          <span class="player-indicator ${indicatorClass}"></span>
          <span>${players[playerId].name}</span>
        `;
        
        option.addEventListener('click', function() {
          // 選択されたプレイヤーを記録
          selectedFromPlayer = fromPlayerId;
          selectedToPlayer = playerId;
          
          // フォームのデザイン更新
          fromPlayerSelect.value = fromPlayerId;
          toPlayerSelect.value = playerId;
          
          // ポップアップを非表示
          playerPopup.style.display = 'none';
          
          // マルチチップセレクターまでスクロール
          document.querySelector('.multi-chip-selector').scrollIntoView({ behavior: 'smooth' });
          
          // アクションタイプを移動に設定
          actionTypeSelect.value = 'transfer';
          actionTypeSelect.dispatchEvent(new Event('change'));
        });
        
        popupContent.appendChild(option);
      }
    });
    
    // ポップアップを表示
    playerPopup.style.display = 'block';
  }
  
  // 抽選されたカードを表示する関数
  function showCard(card) {
    cardTitle.textContent = card.title;
    cardDescription.textContent = card.rule;
    cardModal.style.display = 'flex';
    currentCard = card;
  }
  
  // カードを適用する関数
  function applyCardRule(card) {
    activeRules.push(card);
    updateActiveRules();
    showToast('success', 'カード適用', `「${card.title}」を適用しました。`);
  }
  
  // 適用中のルールを更新する関数
  function updateActiveRules() {
    if (activeRules.length === 0) {
      rulesList.innerHTML = '';
      noRulesMessage.style.display = 'block';
      return;
    }
    
    noRulesMessage.style.display = 'none';
    rulesList.innerHTML = '';
    
    activeRules.forEach((rule, index) => {
      const li = document.createElement('li');
      li.classList.add('rule-item');
      li.innerHTML = `
        <div class="rule-header">
          <span class="rule-name">${rule.title}</span>
          <button class="rule-action" data-index="${index}">削除</button>
        </div>
        <div class="rule-description">${rule.rule}</div>
      `;
      rulesList.appendChild(li);
    });
    
    // 削除ボタンのイベントリスナー
    document.querySelectorAll('.rule-action').forEach(btn => {
      btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        const removedRule = activeRules.splice(index, 1)[0];
        updateActiveRules();
        showToast('warning', 'ルール削除', `「${removedRule.title}」を削除しました。`);
      });
    });
    
    // ローカルストレージに保存
    saveState();
  }
  
  // 残りのカード枚数を更新する関数
  function updateRemainingCards() {
    cardsRemaining.textContent = `${shuffledCards.length}枚`;
  }
  
  // 状態をローカルストレージに保存する関数
  function saveState() {
    const state = {
      players,
      totalForfeit,
      doubleMode,
      history,
      activeRules,
      shuffledCards
    };
    
    localStorage.setItem('momotetsuDashboardState', JSON.stringify(state));
  }
  
  // ローカルストレージから状態を読み込む関数
  function loadState() {
    const savedState = localStorage.getItem('momotetsuDashboardState');
    if (!savedState) return;
    
    try {
      const state = JSON.parse(savedState);
      
      // プレイヤーデータを復元
      Object.keys(state.players).forEach(playerId => {
        players[playerId] = state.players[playerId];
        updatePlayerDisplay(playerId);
      });
      
      // 没収ポイント合計を復元
      totalForfeit = state.totalForfeit;
      updateTotalForfeit();
      
      // 倍モードを復元
      doubleMode = state.doubleMode;
      doubleModeToggle.checked = doubleMode;
      
      // 履歴を復元
      history = state.history || [];
      if (history.length > 0) {
        historySection.innerHTML = '';
        history.forEach(item => {
          const historyItem = document.createElement('div');
          historyItem.classList.add('history-item', item.action);
          
          const timeString = new Date(item.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          
          let message = '';
          if (item.action === 'transfer') {
            // チップの内訳テキストを作成
            let chipDetails = [];
            Object.keys(item.chips).forEach(chipType => {
              if (item.chips[chipType] > 0) {
                const name = getChipTypeName(chipType);
                chipDetails.push(`${name} ×${item.chips[chipType]}`);
              }
            });
            
            message = `${timeString} - ${players[item.from].name} → ${players[item.to].name}: ${chipDetails.join(', ')} (${item.points.toLocaleString()} Pt)`;
          } else if (item.action === 'forfeit') {
            // チップの内訳テキストを作成
            let chipDetails = [];
            Object.keys(item.chips).forEach(chipType => {
              if (item.chips[chipType] > 0) {
                const name = getChipTypeName(chipType);
                chipDetails.push(`${name} ×${item.chips[chipType]}`);
              }
            });
            
            message = `${timeString} - ${players[item.from].name} から没収: ${chipDetails.join(', ')} (${item.points.toLocaleString()} Pt)`;
          } else if (item.action === 'undo') {
            message = `${timeString} - 取消: ${item.from}`;
          }
          
          historyItem.textContent = message;
          historySection.appendChild(historyItem);
        });
      }
      
      // アクティブなルールを復元
      activeRules = state.activeRules || [];
      updateActiveRules();
      
      // シャッフルされたカードを復元
      if (state.shuffledCards && state.shuffledCards.length > 0) {
        shuffledCards = state.shuffledCards;
      }
      updateRemainingCards();
      
      // ランキングを更新
      updateRankings();
      
    } catch (error) {
      console.error('状態の読み込みに失敗しました:', error);
    }
  }
  
  // アクションタイプの変更時の処理
  actionTypeSelect.addEventListener('change', function() {
    const actionType = this.value;
    
    if (actionType === 'transfer') {
      fromPlayerGroup.style.display = 'flex';
      toPlayerGroup.style.display = 'flex';
      toPlayerSelect.querySelector('option[value="forfeit"]').style.display = 'none';
    } else if (actionType === 'forfeit') {
      fromPlayerGroup.style.display = 'flex';
      toPlayerGroup.style.display = 'none';
    }
  });
  
  // プリセットボタンのイベントリスナー
  presetButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const preset = parseInt(this.dataset.preset);
      setChipsByTotal(preset);
    });
  });
  
  // チップ増減ボタンの処理
  document.querySelectorAll('.increase-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const chipType = this.dataset.chipType;
      const quantityElement = document.getElementById(`${chipType}-quantity`);
      
      selectedChips[chipType]++;
      quantityElement.value = selectedChips[chipType];
      
      // 合計ポイントを更新
      totalPoints.textContent = `${calculateSelectedPoints().toLocaleString()} Pt`;
    });
  });
  
  document.querySelectorAll('.decrease-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const chipType = this.dataset.chipType;
      const quantityElement = document.getElementById(`${chipType}-quantity`);
      
      if (selectedChips[chipType] > 0) {
        selectedChips[chipType]--;
        quantityElement.value = selectedChips[chipType];
        
        // 合計ポイントを更新
        totalPoints.textContent = `${calculateSelectedPoints().toLocaleString()} Pt`;
      }
    });
  });
  
  // チップ数量入力フィールドの処理
  document.querySelectorAll('.chip-quantity').forEach(input => {
    input.addEventListener('input', function() {
      const chipType = this.id.split('-')[0];
      const value = parseInt(this.value) || 0;
      
      // 負の値は0に
      if (value < 0) {
        this.value = '0';
        selectedChips[chipType] = 0;
      } else {
        selectedChips[chipType] = value;
      }
      
      // 合計ポイントを更新
      totalPoints.textContent = `${calculateSelectedPoints().toLocaleString()} Pt`;
    });
  });
  
  // フォーム送信時の処理
  submitActionBtn.addEventListener('click', function() {
    const actionType = actionTypeSelect.value;
    const fromPlayer = fromPlayerSelect.value;
    const toPlayer = toPlayerSelect.value;
    
    // チップが選択されているか確認
    const totalChips = Object.values(selectedChips).reduce((sum, count) => sum + count, 0);
    if (totalChips === 0) {
      showToast('error', 'エラー', 'チップが選択されていません。');
      return;
    }
    
    if (actionType === 'transfer') {
      if (fromPlayer === toPlayer) {
        showToast('error', 'エラー', '送信元と送信先が同じです。');
        return;
      }
      
      // 移動確認モーダルを表示
      let chipDetails = [];
      Object.keys(selectedChips).forEach(chipType => {
        if (selectedChips[chipType] > 0) {
          chipDetails.push(`${getChipTypeName(chipType)} ${selectedChips[chipType]}枚`);
        }
      });
      
      const totalPointsValue = calculateSelectedPoints();
      
      transferModalBody.innerHTML = `<p>${players[fromPlayer].name}から ${players[toPlayer].name} へ ${chipDetails.join('、')} (${totalPointsValue.toLocaleString()} Pt) を移動します。</p>`;
      transferModal.style.display = 'flex';
      
      // 確認ボタンのイベントリスナー（一旦削除してから再登録）
      confirmTransferBtn.onclick = null;
      confirmTransferBtn.onclick = function() {
        if (executeTransfer(fromPlayer, toPlayer, {...selectedChips})) {
          transferModal.style.display = 'none';
        }
      };
      
    } else if (actionType === 'forfeit') {
      // 没収確認モーダルを表示
      let chipDetails = [];
      const displayChips = {...selectedChips};
      
      if (doubleMode) {
        Object.keys(displayChips).forEach(chipType => {
          displayChips[chipType] *= 2;
        });
      }
      
      Object.keys(displayChips).forEach(chipType => {
        if (displayChips[chipType] > 0) {
          chipDetails.push(`${getChipTypeName(chipType)} ${displayChips[chipType]}枚`);
        }
      });
      
      let totalPointsValue = 0;
      Object.keys(displayChips).forEach(chipType => {
        totalPointsValue += CHIP_VALUES[chipType] * displayChips[chipType];
      });
      
      forfeitModalBody.innerHTML = `<p>${players[fromPlayer].name}から ${chipDetails.join('、')} (${totalPointsValue.toLocaleString()} Pt) を没収します。${doubleMode ? '<br><strong>※倍モード適用中</strong>' : ''}</p>`;
      forfeitModal.style.display = 'flex';
      
      // 確認ボタンのイベントリスナー（一旦削除してから再登録）
      confirmForfeitBtn.onclick = null;
      confirmForfeitBtn.onclick = function() {
        if (executeForfeit(fromPlayer, {...selectedChips})) {
          forfeitModal.style.display = 'none';
        }
      };
    }
    </script>
</body>
</html>
